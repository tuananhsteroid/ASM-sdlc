<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giao Diện Shipper</title>
    <link rel="stylesheet" href="assets/css/shipper.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>

    <div class="header">
        <div class="status-toggle">
            <span class="status-text" id="status-text">Đang hoạt động</span>
            <label class="switch">
                <input type="checkbox" id="status-switch" checked>
                <span class="slider round"></span>
            </label>
        </div>
        <div class="user-info">
            <i class="fas fa-user-circle"></i>
            <span id="user-fullname"></span>
        </div>
    </div>

    <div class="main-content">
        <div class="map-placeholder">
            <h3>Bản đồ</h3>
        </div>

        <div class="order-list">
            <h2>Đơn hàng mới</h2>
            <div id="new-orders-list">
                <div class="loading-message">Đang tải đơn hàng mới...</div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Kiểm tra phiên đăng nhập và vai trò
            fetch('api/auth/session.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.loggedIn) {
                        document.getElementById('user-fullname').textContent = data.user.fullname;

                        if (data.user.role !== 'Shipper') {
                            alert('Bạn không có quyền truy cập trang này.');
                            window.location.href = 'login.html';
                        } else {
                            loadNewOrders(); // Chỉ tải đơn hàng nếu là shipper
                        }
                    } else {
                        window.location.href = 'login.html';
                    }
                })
                .catch(error => {
                    console.error('Lỗi kiểm tra session:', error);
                    window.location.href = 'login.html';
                });
        });

        async function loadNewOrders() {
            const orderListEl = document.getElementById('new-orders-list');
            orderListEl.innerHTML = '<div class="loading-message">Đang tải đơn hàng mới...</div>';

            try {
                const res = await fetch('api/shipper/read_new_orders.php');
                const data = await res.json();

                if (data.success && data.orders.length > 0) {
                    displayNewOrders(data.orders);
                } else {
                    orderListEl.innerHTML = '<div class="no-orders-message">Hiện không có đơn hàng mới.</div>';
                }
            } catch (e) {
                orderListEl.innerHTML = '<div class="error-message">Lỗi khi tải đơn hàng. Vui lòng thử lại.</div>';
                console.error("Lỗi khi tải đơn hàng mới:", e);
            }
        }

        function displayNewOrders(orders) {
            const orderListEl = document.getElementById('new-orders-list');
            orderListEl.innerHTML = ''; // Xóa thông báo loading

            orders.forEach(order => {
                const orderHtml = `
                    <div class="order-card" data-order-id="${order.OrderID}">
                        <div class="order-header">
                            <span class="order-type">Đơn hàng #${order.OrderID}</span>
                            <span class="distance"><i class="fas fa-map-marker-alt"></i> ${order.Distance} km</span>
                        </div>
                        <div class="order-details">
                            <p><strong>Khách hàng:</strong> ${order.CustomerName}</p>
                            <p><strong>Điểm lấy hàng:</strong> ${order.PickupAddress}</p>
                            <p><strong>Điểm giao hàng:</strong> ${order.DeliveryAddress}</p>
                        </div>
                        <div class="order-footer">
                            <span class="price">Tổng tiền: ${Number(order.TotalPrice).toLocaleString('vi-VN')} VNĐ</span>
                            <button class="btn-accept" data-id="${order.OrderID}">Chấp nhận</button>
                        </div>
                    </div>
                `;
                orderListEl.innerHTML += orderHtml;
            });
            
            // Gắn trình xử lý sự kiện cho nút "Chấp nhận"
            orderListEl.addEventListener('click', async (e) => {
                const acceptBtn = e.target.closest('.btn-accept');
                if (acceptBtn) {
                    const orderId = acceptBtn.dataset.id;
                    if (confirm(`Bạn có chắc muốn chấp nhận đơn hàng #${orderId}?`)) {
                        await acceptOrder(orderId);
                    }
                }
            });
        }

        async function acceptOrder(orderId) {
            try {
                const response = await fetch('api/shipper/accept_order.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId: orderId })
                });
                const result = await response.json();
                alert(result.message);
                if (result.success) {
                    // Cập nhật lại danh sách đơn hàng sau khi chấp nhận
                    loadNewOrders(); 
                }
            } catch (error) {
                console.error('Lỗi khi chấp nhận đơn hàng:', error);
                alert('Lỗi khi kết nối đến máy chủ.');
            }
        }
    </script>
</body>

</html>